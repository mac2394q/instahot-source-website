(function($){$('#gamipress-transfers-change-user, #gamipress-transfers-change-recipient').click(function(e){e.preventDefault();var $this=$(this);var field=$this.closest('.cmb-td').find('select');var actions=$this.parent();var field_actions=actions.prev();field.data('current',field.val());if(!field.hasClass('.select2-hidden-accessible')){field.select2({ajax:{url:ajaxurl,dataType:'json',delay:250,type:'POST',data:function(params){return{q:params.term,action:'gamipress_get_users'}},processResults:gamipress_select2_users_process_results},escapeMarkup:function(markup){return markup},templateResult:gamipress_select2_users_template_result,theme:'default gamipress-select2',placeholder:'Select an User',allowClear:!0,multiple:!1})}
actions.slideUp();field.slideDown();field.next('.select2').slideDown();field_actions.slideDown()});$('.save-user-select').click(function(e){e.preventDefault();var $this=$(this);var field=$this.closest('.cmb-td').find('select');var field_actions=$this.parent();var actions=field_actions.next();var user_id=field.val();var prev_id=field.data('current');if(parseInt(user_id)!==parseInt(prev_id)){var user_data=field.select2('data')[0];var user_name_element=$this.closest('.cmb-td').find('h2');var user_email_element=$this.closest('.cmb-td').find('.user-email');if(user_data.user_email!==undefined){user_name_element.html(user_data.display_name);user_email_element.html(user_data.user_email)}else{user_name_element.html(user_name_element.data('original'));user_email_element.html(user_email_element.data('original'))}
var profile_link=actions.find('a');profile_link.attr('href',profile_link.attr('href').replace('user_id='+prev_id,'user_id='+user_id));profile_link.attr('href',profile_link.attr('href').replace('profile.php','user-edit.php?user_id='+user_id))}
actions.slideDown();field.slideUp();field.next('.select2').slideUp();field_actions.slideUp()});$('.cancel-user-select').click(function(e){e.preventDefault();var $this=$(this);var field=$this.closest('.cmb-td').find('select');var field_actions=$this.parent();var actions=field_actions.next();field.val(field.data('current'));actions.slideDown();field.slideUp();field.next('.select2').slideUp();field_actions.slideUp()});function gamipress_transfers_transfer_check_item_assignments(item){var container=item.find('.gamipress-transfers-transfer-items-assignment');var container_text=container.find('.gamipress-transfers-transfer-items-assignment-text');var container_fields=container.find('.gamipress-transfers-transfer-items-assignment-fields');var post_id=parseInt(item.find('input[name$="[post_id]"]').val());var post_type=item.find('input[name$="[post_type]"]').val();if(post_id===0||isNaN(post_id)){container_text.html(gamipress_transfers_transfers.strings.no_assignment)}else{var item_title='';if(post_type in gamipress_transfers_transfers.points_types){item_title=gamipress_transfers_transfers.points_types[post_type].plural_name}else if(post_type in gamipress_transfers_transfers.achievement_types){item_title=gamipress_transfers_transfers.achievement_types[post_type].singular_name}else if(post_type in gamipress_transfers_transfers.rank_types){item_title=gamipress_transfers_transfers.rank_types[post_type].singular_name}
var item_url=gamipress_transfers_transfers.admin_url+'post.php?post='+post_id+'&action=edit';var item_link='<a href="'+item_url+'" target="_blank">'+item_title+'</a>';var text=gamipress_transfers_transfers.strings.assignment.replace('{item_link}',item_link);container_text.html(text);container_fields.find('.gamipress-transfers-transfer-items-assignment-post-type').val(post_type)}}
$('.cmb2-id-transfer-items .cmb-repeatable-grouping').each(function(){gamipress_transfers_transfer_check_item_assignments($(this))});$('body').on('click','.cmb2-id-transfer-items .cmb-add-group-row',function(e){setTimeout(function(){var item=$('.cmb2-id-transfer-items').find('.cmb-repeatable-grouping').last();gamipress_transfers_transfer_check_item_assignments(item)},10)});$('body').on('click','.gamipress-transfers-transfer-items-assignment .gamipress-transfers-assign-post-to-item',function(e){e.preventDefault();var container=$(this).closest('.gamipress-transfers-transfer-items-assignment');var container_text=container.find('.gamipress-transfers-transfer-items-assignment-text');var container_fields=container.find('.gamipress-transfers-transfer-items-assignment-fields');container_text.slideUp();container_fields.slideDown()});$('body').on('click','.gamipress-transfers-transfer-items-assignment .gamipress-transfers-unassign-post-to-item',function(e){e.preventDefault();var item=$(this).closest('.cmb-repeatable-grouping');item.find('input[name$="[post_id]"]').val('0');item.find('input[name$="[post_type]"]').val('');gamipress_transfers_transfer_check_item_assignments(item)});$('body').on('change','.gamipress-transfers-transfer-items-assignment .gamipress-transfers-transfer-items-assignment-post-type',function(e){var post_type=$(this).val();var item=$(this).closest('.cmb-repeatable-grouping');var container=$(this).closest('.gamipress-transfers-transfer-items-assignment');var container_text=container.find('.gamipress-transfers-transfer-items-assignment-text');var container_fields=container.find('.gamipress-transfers-transfer-items-assignment-fields');var post_id_field=container_fields.find('.gamipress-transfers-transfer-items-assignment-post-id');if(post_type in gamipress_transfers_transfers.points_types){var post_id=gamipress_transfers_transfers.points_types[post_type].ID;var plural_name=gamipress_transfers_transfers.points_types[post_type].plural_name;post_id_field.html('<option value="'+post_id+'">'+plural_name+'</option>');post_id_field.val(post_id);post_id_field.hide()}else{var action='';if(post_type in gamipress_transfers_transfers.achievement_types){action='gamipress_get_achievements_options_html'}else if(post_type in gamipress_transfers_transfers.rank_types){action='gamipress_get_ranks_options_html'}
var spinner=container_fields.find('.spinner');var save_button=container_fields.find('.save-assignment');post_id_field.slideUp();spinner.addClass('is-active');save_button.addClass('disabled');$.ajax({url:ajaxurl,data:{action:action,post_type:post_type,achievement_type:post_type,selected:post_id_field.val()},success:function(response){spinner.removeClass('is-active');save_button.removeClass('disabled');post_id_field.html(response);post_id_field.slideDown()}})}});$('body').on('click','.gamipress-transfers-transfer-items-assignment .save-assignment',function(e){e.preventDefault();if($(this).hasClass('disabled')){return}
var item=$(this).closest('.cmb-repeatable-grouping');var container=$(this).closest('.gamipress-transfers-transfer-items-assignment');var container_text=container.find('.gamipress-transfers-transfer-items-assignment-text');var container_fields=container.find('.gamipress-transfers-transfer-items-assignment-fields');var post_id_field=container_fields.find('.gamipress-transfers-transfer-items-assignment-post-id');var post_id=0;var post_type=container_fields.find('.gamipress-transfers-transfer-items-assignment-post-type').val();if(post_type in gamipress_transfers_transfers.points_types){post_id=gamipress_transfers_transfers.points_types[post_type].ID}else{post_id=parseInt(post_id_field.val())}
item.find('input[name$="[post_id]"]').val(post_id);item.find('input[name$="[post_type]"]').val(post_type);gamipress_transfers_transfer_check_item_assignments(item);container_text.slideDown();container_fields.slideUp()});$('body').on('click','.gamipress-transfers-transfer-items-assignment .cancel-assignment',function(e){e.preventDefault();var container=$(this).closest('.gamipress-transfers-transfer-items-assignment');var container_text=container.find('.gamipress-transfers-transfer-items-assignment-text');var container_fields=container.find('.gamipress-transfers-transfer-items-assignment-fields');container_text.slideDown();container_fields.slideUp()});$('#add-new-transfer-note').click(function(e){e.preventDefault();$(this).parent().slideUp();$('#new-transfer-note-fieldset').slideDown()});$('#save-transfer-note').click(function(e){e.preventDefault();var $this=$(this);if($this.hasClass('disabled')){return}
$this.addClass('disabled');var title=$('#transfer-note-title').val();var description=$('#transfer-note-description').val();var notice=$('#new-transfer-note-submit .notice');if(title.length===0||description.length===0){notice.find('.error').html('Please, fill the form correctly');notice.removeClass('hidden');return}
if(!notice.hasClass('hidden')){notice.addClass('hidden')}
$.ajax({url:ajaxurl,data:{action:'gamipress_transfers_add_transfer_note',transfer_id:$('#ct_edit_form input#object_id').val(),title:title,description:description},success:function(response){if(response.success){$('.transfer-notes-list tbody').prepend(response.data);$this.closest('#new-transfer-note-fieldset').slideUp();$this.closest('#new-transfer-note-fieldset').prev().slideDown();$('#transfer-note-title').val('');$('#transfer-note-description').val('')}else{notice.find('.error').html(response.data);notice.removeClass('hidden')}
$this.removeClass('disabled')}})});$('#cancel-transfer-note').click(function(e){e.preventDefault();$(this).closest('#new-transfer-note-fieldset').slideUp();$(this).closest('#new-transfer-note-fieldset').prev().slideDown();$('#transfer-note-title').val('');$('#transfer-note-description').val('')});$('.transfer-note .row-actions .delete').click(function(e){e.preventDefault();var confirmed=confirm('Do you want to remove this transfer note?');var $this=$(this);if(confirmed){$this.closest('.transfer-note').fadeOut();$.ajax({url:ajaxurl,data:{action:'gamipress_transfers_delete_transfer_note',transfer_note_id:$this.data('transfer-note-id'),},success:function(response){if(response.success){$this.closest('.transfer-note').remove()}else{$this.closest('.transfer-note').fadeIn()}}})}})})(jQuery)