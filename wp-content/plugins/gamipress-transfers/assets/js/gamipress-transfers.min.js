(function($){$('body').on('submit','.gamipress-transfers-form',function(e){e.preventDefault();return!1});$('body').on('keypress','.gamipress-transfers-form',function(e){return e.keyCode!=13});$('body').on('click','.gamipress-transfers-form .gamipress-transfers-form-submit-button',function(e){e.preventDefault();var $this=$(this);var form=$(this).closest('.gamipress-transfers-form');var submit_wrap=form.find('.gamipress-transfers-form-submit');var recipient_input=form.find('.gamipress-transfers-recipient-form-recipient-input');var recipient_id=parseInt(form.find('input[name="recipient_id"]').val());var user_points=parseInt(form.find('input[name="user_points"]').val());if(submit_wrap.find('.gamipress-transfers-form-response').length===0){submit_wrap.prepend('<div class="gamipress-transfers-form-response" style="display: none;"></div>')}
var response_wrap=submit_wrap.find('.gamipress-transfers-form-response');if(recipient_input.length&&!recipient_input.hasClass('.gamipress-transfers-recipient-form-recipient-autocomplete')){recipient_id=-1}
if(isNaN(recipient_id)||recipient_id===0){response_wrap.addClass('gamipress-transfers-error');response_wrap.html(gamipress_transfers.no_recipient_error);response_wrap.slideDown();return}
if(form.hasClass('gamipress-transfers-points-transfer-form')){var amount=parseInt(form.find('input[name="amount"]').val());if(isNaN(amount)||amount>user_points){response_wrap.addClass('gamipress-transfers-error');response_wrap.html(gamipress_transfers.insufficient_amount_error);response_wrap.slideDown();return}}
$this.prop('disabled',!0);if(response_wrap.length){response_wrap.slideUp()}
submit_wrap.find('.gamipress-spinner').show();form.trigger('gamipress_transfers_before_transfer_request');$.ajax({url:gamipress_transfers.ajaxurl,method:'POST',data:form.serialize()+'&action=gamipress_transfers_process_transfer',success:function(response){response_wrap.addClass('gamipress-transfers-'+(response.success===!0?'success':'error'));response_wrap.html((response.data.message!==undefined?response.data.message:response.data));response_wrap.slideDown();if(response.success!==!0){$this.prop('disabled',!1)}
submit_wrap.find('.gamipress-spinner').hide();form.trigger('gamipress_transfers_transfer_'+(response.success===!0?'success':'error'));form.trigger('gamipress_transfers_after_transfer_request');if(response.data.redirect===!0&&response.data.redirect_url!==undefined&&response.data.redirect_url.length){window.location.href=response.data.redirect_url}},error:function(response){form.trigger('gamipress_transfers_transfer_error');form.trigger('gamipress_transfers_after_transfer_request')}})});var gamipress_transfers_users_cache={};$('input.gamipress-transfers-recipient-form-recipient-autocomplete').each(function(){var $this=$(this);var form=$this.closest('.gamipress-transfers-form');var parent_id=$this.parent().attr('id');$(this).autocomplete({minLength:2,source:function(request,response){var term=request.term;if(term in gamipress_transfers_users_cache){response(gamipress_transfers_users_cache[term]);return}
request.action='gamipress_transfers_users_autocomplete';$.getJSON(gamipress_transfers.ajaxurl,request,function(data,status,xhr){gamipress_transfers_users_cache[term]=data;response(data)})},messages:{noResults:'',results:function(){}},select:function(event,ui){$this.val(ui.item.label);form.find('input[name="recipient_id"]').val(ui.item.value);return!1},appendTo:'#'+parent_id})});function gamipress_transfers_update_form_balance(form,amount){if(isNaN(amount)){amount=0}
form.find('.gamipress-transfers-points-transfer-form-total-amount').text(amount);form.find('input[name="amount"]').val(amount);var current_balance=parseInt(form.find('.gamipress-transfers-points-transfer-form-current-balance-amount').text());var new_balance_wrap=form.find('.gamipress-transfers-points-transfer-form-new-balance-amount');var new_balance=current_balance-amount;new_balance_wrap.text(new_balance);if(new_balance>1){new_balance_wrap.removeClass('gamipress-transfers-negative').addClass('gamipress-transfers-positive')}else{new_balance_wrap.removeClass('gamipress-transfers-positive').addClass('gamipress-transfers-negative')}}
$('body').on('change keyup','.gamipress-transfers-points-transfer-form-custom-amount',function(){var form=$(this).closest('.gamipress-transfers-form');var amount=parseInt($(this).val());gamipress_transfers_update_form_balance(form,amount)});$('body').on('change','.gamipress-transfers-points-transfer-form-option input',function(){var target=$(this).closest('.gamipress-transfers-points-transfer-form-options').find('.gamipress-transfers-points-transfer-form-options-custom-amount');if($(this).val()==='custom'){target.find('input').change();target.slideDown()}else{target.slideUp();var form=$(this).closest('.gamipress-transfers-form');var amount=parseInt($(this).val());gamipress_transfers_update_form_balance(form,amount)}});$('.gamipress-transfers-points-transfer-form-option input:checked').change();$('body').on('change keyup','.gamipress-transfers-points-transfer-form-options-custom-amount-input',function(){var form=$(this).closest('.gamipress-transfers-form');var amount=parseInt($(this).val());gamipress_transfers_update_form_balance(form,amount)});var gamipress_transfers_achievements_cache={};var gamipress_transfers_achievements_render_cache={};$('input.gamipress-transfers-achievement-transfer-form-achievement-input').each(function(){var $this=$(this);var form=$this.closest('.gamipress-transfers-form');var parent_id=$this.parent().attr('id');$(this).autocomplete({minLength:0,source:function(request,response){var term=request.term;if(term in gamipress_transfers_achievements_cache){response(gamipress_transfers_achievements_cache[term]);return}
request.action='gamipress_transfers_achievements_autocomplete';$.getJSON(gamipress_transfers.ajaxurl,request,function(data,status,xhr){gamipress_transfers_achievements_cache[term]=data;response(data)})},messages:{noResults:'',results:function(){}},select:function(event,ui){var achievement_id=ui.item.value;$this.val(ui.item.label);form.find('input[name="achievement_id"]').val(achievement_id);var achievement_wrap=form.find('.gamipress-transfers-form-achievement-wrapper');var achievement_render=achievement_wrap.find('.gamipress-transfers-form-achievement-render');if(achievement_id in gamipress_transfers_achievements_render_cache){achievement_render.html(gamipress_transfers_achievements_render_cache[achievement_id]);return}
achievement_render.html('<span class="gamipress-spinner"></span>');var request={action:'gamipress_transfers_get_achievement_render',achievement_id:achievement_id};form.find('.gamipress-transfers-form-achievement-wrapper input').each(function(){request[$(this).data('name')]=$(this).val()});$.get(gamipress_transfers.ajaxurl,request,function(data,status,xhr){gamipress_transfers_achievements_render_cache[achievement_id]=data;achievement_render.html(data)});return!1},appendTo:'#'+parent_id}).bind('focus',function(){$(this).autocomplete("search")}).autocomplete("instance")._renderItem=function(ul,item){return $("<li>").append(item.display_label).appendTo(ul)}});var gamipress_transfers_ranks_cache={};var gamipress_transfers_ranks_render_cache={};$('input.gamipress-transfers-rank-transfer-form-rank-input').each(function(){var $this=$(this);var form=$this.closest('.gamipress-transfers-form');var parent_id=$this.parent().attr('id');$(this).autocomplete({minLength:0,source:function(request,response){var term=request.term;if(term in gamipress_transfers_ranks_cache){response(gamipress_transfers_ranks_cache[term]);return}
request.action='gamipress_transfers_ranks_autocomplete';$.getJSON(gamipress_transfers.ajaxurl,request,function(data,status,xhr){gamipress_transfers_ranks_cache[term]=data;response(data)})},messages:{noResults:'',results:function(){}},select:function(event,ui){var rank_id=ui.item.value;$this.val(ui.item.label);form.find('input[name="rank_id"]').val(rank_id);var rank_wrap=form.find('.gamipress-transfers-form-rank-wrapper');var rank_render=rank_wrap.find('.gamipress-transfers-form-rank-render');if(rank_id in gamipress_transfers_ranks_render_cache){rank_render.html(gamipress_transfers_ranks_render_cache[rank_id]);return}
rank_render.html('<span class="gamipress-spinner"></span>');var request={action:'gamipress_transfers_get_rank_render',rank_id:rank_id};form.find('.gamipress-transfers-form-rank-wrapper input').each(function(){request[$(this).data('name')]=$(this).val()});$.get(gamipress_transfers.ajaxurl,request,function(data,status,xhr){gamipress_transfers_ranks_render_cache[rank_id]=data;rank_render.html(data)});return!1},appendTo:'#'+parent_id}).bind('focus',function(){$(this).autocomplete("search")}).autocomplete("instance")._renderItem=function(ul,item){return $("<li>").append(item.display_label).appendTo(ul)}})})(jQuery)