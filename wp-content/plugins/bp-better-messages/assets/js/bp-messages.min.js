function BBPMNotice(e){jQuery.amaran({theme:"colorful",content:{bgcolor:"black",color:"#fff",message:e},sticky:!1,closeOnClick:!0,closeButton:!0,delay:1e4,position:"bottom right"})}function BBPMShowError(e){jQuery.amaran({theme:"colorful",content:{bgcolor:"#c0392b",color:"#fff",message:e},sticky:!1,closeOnClick:!0,closeButton:!0,delay:1e4,position:"bottom right"})}function BBPMOpenMiniChat(e,s){$(document).trigger("bp-better-messages-open-mini-chat",[e,s])}function BBPMOpenPrivateThread(e){$(document).trigger("bp-better-messages-open-private-thread",[e])}!function(e){function s(s){e.each(s,function(){var s=e('.bp-messages-wrap .list .messages-stack .content .messages-list li[data-id="'+this+'"]'),t=s.closest(".messages-stack");s.remove();0===t.find(".messages-list > li").length&&t.remove(),e('.bp-messages-wrap .threads-list .thread[data-message="'+this+'"] .info p').text("...")})}function t(){function t(){jQuery(".bp-messages-wrap .scroller.thread").show(),jQuery(".bp-messages-wrap .bp-messages-video-container").hide();var e=jQuery(".bp-messages-wrap .bp-messages-video-container .bp-messages-main-video"),s=jQuery(".bp-messages-wrap .bp-messages-video-container .bp-messages-small-video");e.hide(),e.html(""),s.hide(),s.html(""),jQuery(".bp-messages-call-controls").hide(),jQuery(".bp-messages-call-controls .bpbm-enable-mic").hide(),jQuery(".bp-messages-call-controls .bpbm-disable-mic").show(),jQuery(".bp-messages-call-controls .bpbm-enable-video").hide(),jQuery(".bp-messages-call-controls .bpbm-disable-video").show(),clearInterval(v),!1!==h&&h.getTracks().forEach(function(e){e.stop()}),!1!==d&&d.close(),h=!1,u=!1,d=!1,_=!1}function i(){if(!1===P)return!1;ion.sound.stop("calling"),P=!1}function n(){if(!1!==d)return!1;try{(d=new U({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}]})).peers={},d.onicecandidate=function(e){e.candidate&&M.emit("mediaEvent",{event:"ice_message",candidate:e.candidate,to:d.participant})},d.oniceconnectionstatechange=function(e){"failed"!==d.iceConnectionState&&"disconnected"!==d.iceConnectionState&&"closed"!==d.iceConnectionState||(t(),BBPMNotice(BP_Messages.strings.connection_drop))},d.onice=function(e){if(d.peers[e.from]){d.addIceCandidate(e.candidate);for(var s=0;s<k.length;s++)d.addIceCandidate(k[s]);k=[]}else k.push(k)},d.ontrack=function(s){var t=!1;s.streams&&s.streams[0]?t=s.streams[0]:(b||(t=b=new MediaStream),b.addTrack(s.track)),"video"===s.track.kind&&function(s){n();var t=document.createElement("video"),a=e(".bp-messages-video-container");a.find(".bp-messages-main-video").html(t),a.show(),t.srcObject=s,t.controls=!0,t.muted=!1,t.controls=!1,t.play(),o(a)}(t)}}catch(e){console.error(e)}}function r(s){n();var t=document.createElement("video"),a=e(".bp-messages-video-container");a.find(".bp-messages-small-video").show(),a.find(".bp-messages-small-video").html(t),a.show(),t.srcObject=s,t.controls=!0,t.muted=!0,t.controls=!1,t.play()}function o(e){if(!H)return!1;var s=e.closest(".bp-messages-wrap").find(".scroller.thread").height();e.find(".bp-messages-main-placeholder").is(":visible")?e.find(".bp-messages-main-placeholder").height(s):e.find(".bp-messages-main-video").height(s)}function l(e){!function(e,s,t){if(e||(e={audio:!0,video:!0}),!s)throw"Second argument is mandatory. navigator.getUserMedia(hints,onsuccess,onfailure)";navigator.mediaDevices.getUserMedia(e).then(function(e){s(e)}).catch(function(e){if(!t)throw Error("getUserMedia failed: "+JSON.stringify(e,null,"\t"));t(e)})}({audio:!0,video:{optional:[],mandatory:{minWidth:640,minHeight:360,maxWidth:1920,maxHeight:1080}}},function(s){var t=document.createElement("video");t.srcObject=s,t.controls=!0,t.muted=!0,e(s,t,!1)},function(s){s&&e(null,null,s)})}try{M=io.connect(BP_Messages.socket_server)}catch(e){return console.error("Error connecting to the WebSocket Server. Please contact plugin developer. https://www.wordplus.org/contact/"),BP_Messages.realtime=0,!1}M.on("connect",function(){M.emit("authentication",BP_Messages.site_id,BP_Messages.user_id,BP_Messages.secret_key)}),M.on("disconnect",function(){BP_Messages.realtime=0}),M.on("reconnect",function(){BP_Messages.realtime=1});var d=!1,h=!1,u=!1,b=!1,v=!1,_=!1,k=[],P=!1,j={},x={},D={optional:[],mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}};M.on("mediaEvent",function(s){var a=e(".bp-messages-video-container"),o=a.closest(".bp-messages-wrap");switch(s.event){case"answered":n(),clearInterval(v),o.find(".bp-messages-main-placeholder").hide(),o.find(".bp-messages-main-placeholder .bp-messages-placeholder-video").html(""),o.find(".bp-messages-main-video").show(),a.find(".bp-messages-call-controls > *").hide(),a.find(".bp-messages-call-controls").show(),a.find(".bp-messages-call-controls > .bpbm-call-in-progress").show(),r(h),_=!0;break;case"rejected":BBPMNotice(BP_Messages.strings.call_reject),clearInterval(v),_=!1,t();break;case"calling":if(_)return!1;if(void 0!==j[s.from])return!1;if(n(),function(){if(!0===P)return!1;ion.sound.play("calling",{loop:!0}),P=!0}(),B&&s.thread_id===B.toString())o.find(".scroller.thread").hide(),a.show(),a.find(".bp-messages-placeholder-message > *").hide(),a.find(".bp-messages-placeholder-message > .bp-messages-placeholder-incoming-text").show(),a.find(".bp-messages-call-controls > *").hide(),a.find(".bp-messages-call-controls").show(),a.find(".bp-messages-call-controls > .bpbm-call-in").show(),a.find(".bp-messages-main-placeholder").show(),!1===u?l(function(e,s,t){if(!1!==t){console.error(t);var i=t.toString().split(":");BBPMShowError(BP_Messages.strings.cam_not_works+": "+i[1])}else h=e,u=s,a.find(".bp-messages-placeholder-video").html(u),u.controls=!1,u.play()}):(a.find(".bp-messages-placeholder-video").html(u),u.controls=!1,u.play());else{0===(m=e(".amaran.incoming_call.thread_"+s.thread_id)).length&&e.amaran({theme:"user message thread_"+s.thread_id+" incoming_call",content:{img:s.avatar,user:s.name,message:'<div style="float: left;height: 35px;line-height: 35px;">'+BP_Messages.strings.incoming_call+'</div><div class="bp-messages-wrap bp-messages-popup"><div class="bpbm-call-in"><span class="bpbm-answer" data-thread-id="'+s.thread_id+'"  data-user-id="'+s.from+'" title="'+BP_Messages.strings.answer_call+'"><i class="fas fa-phone"></i></span><span class="bpbm-reject" data-thread-id="'+s.thread_id+'"  data-user-id="'+s.from+'" title="'+BP_Messages.strings.reject_call+'"><i class="fas fa-phone"></i></span></div></div>'},sticky:!0,closeOnClick:!1,closeButton:!1,delay:999999,thread_id:s.thread_id,position:"bottom right",onClick:function(){}})}void 0!==x[s.from]&&clearTimeout(x[s.from]),x[s.from]=setTimeout(function(){i(),t();var s=e(".amaran.incoming_call");s.length>0&&s.remove()},3e3);break;case"offer":n();var c=new O(s.sdp);d.peers[s.from]=d.setRemoteDescription(c).then(function(){return h}).then(function(e){h.getTracks().forEach(function(e){d.addTrack(e,h)})}).then(function(){return d.createAnswer()}).then(function(e){return d.setLocalDescription(e)}).then(function(){M.emit("mediaEvent",{event:"answer",to:s.from,sdp:d.localDescription})});break;case"answer":n(),d.setRemoteDescription(new O(s.sdp));break;case"self_reject":i();(m=e(".amaran.incoming_call")).length>0&&m.remove(),j[s.from]="1",setTimeout(function(){delete j[s.from]},3e3);break;case"call_cancelled":i();var m=e(".amaran.incoming_call.thread_"+s.thread_id);m.length>0&&m.remove(),j[s.from]="1",setTimeout(function(){delete j[s.from]},3e3),t();break;case"call_end":t();break;case"ice_message":d.onice(s)}}),jQuery(document).on("click",".bp-messages-wrap .chat-header .video-call",function(s){s.preventDefault(),s.stopImmediatePropagation();var t=jQuery(this).data("user-id");-1===T.indexOf(t.toString())?BBPMShowError(BP_Messages.strings.call_offline):l(function(s,a,i){if(!1!==i){console.error(i);var r=i.toString().split(":");BBPMShowError(BP_Messages.strings.cam_not_works+": "+r[1])}else{var l=e(".bp-messages-video-container");h=s,u=a,l.find(".bp-messages-placeholder-video").html(a),a.controls=!1,a.play(),n(),d.participant=t;var c=l.closest(".bp-messages-wrap"),m=l.data("my-avatar"),p=l.data("my-name");c.find(".scroller.thread").hide(),l.show(),l.find(".bp-messages-placeholder-message > *").hide(),l.find(".bp-messages-placeholder-message > .bp-messages-placeholder-outgoing-text").show(),l.find(".bp-messages-call-controls > *").hide(),l.find(".bp-messages-call-controls").show(),l.find(".bp-messages-call-controls > .bpbm-call-out").show(),l.find(".bp-messages-main-placeholder").show(),M.emit("mediaEvent",{event:"calling",to:t,thread_id:B,avatar:m,name:p}),v=setInterval(function(){M.emit("mediaEvent",{event:"calling",to:t,thread_id:B,avatar:m,name:p})},2500),o(l)}})}),jQuery(document).on("click",".bp-messages-call-controls .bpbm-disable-video",function(e){e.preventDefault(),h.getVideoTracks()[0].enabled=!1,jQuery(".bp-messages-call-controls .bpbm-disable-video").hide(),jQuery(".bp-messages-call-controls .bpbm-enable-video").show()}),jQuery(document).on("click",".bp-messages-call-controls .bpbm-enable-video",function(e){e.preventDefault(),h.getVideoTracks()[0].enabled=!0,jQuery(".bp-messages-call-controls .bpbm-enable-video").hide(),jQuery(".bp-messages-call-controls .bpbm-disable-video").show()}),jQuery(document).on("click",".bp-messages-call-controls .bpbm-disable-mic",function(e){e.preventDefault(),h.getAudioTracks()[0].enabled=!1,jQuery(".bp-messages-call-controls .bpbm-disable-mic").hide(),jQuery(".bp-messages-call-controls .bpbm-enable-mic").show()}),jQuery(document).on("click",".bp-messages-call-controls .bpbm-enable-mic",function(e){e.preventDefault(),h.getAudioTracks()[0].enabled=!0,jQuery(".bp-messages-call-controls .bpbm-enable-mic").hide(),jQuery(".bp-messages-call-controls .bpbm-disable-mic").show()}),jQuery(document).on("click",".bp-messages-call-controls .bpbm-answer",function(s){s.preventDefault(),n();var t=jQuery(this).data("user-id");d.participant=t,void 0!==x[t]&&clearTimeout(x[t]),M.emit("mediaEvent",{event:"answered",to:t}),M.emit("mediaEvent",{event:"self_reject",to:BP_Messages.user_id}),j[t]="1",setTimeout(function(){delete j[t]},3e3),i();var a=e(".bp-messages-video-container"),o=a.closest(".bp-messages-wrap");o.find(".bp-messages-main-placeholder").hide(),o.find(".bp-messages-main-placeholder .bp-messages-placeholder-video").html(""),o.find(".bp-messages-main-video").show(),a.find(".bp-messages-call-controls > *").hide(),a.find(".bp-messages-call-controls").show(),a.find(".bp-messages-call-controls > .bpbm-call-in-progress").show(),r(h),"function"==typeof d.addTrack&&(h.getTracks().forEach(function(e){d.addTrack(e,h)}),d.peers[t]=d.createOffer(D).then(function(e){d.setLocalDescription(e).then(function(){M.emit("mediaEvent",{event:"offer",to:t,sdp:e})})}).catch(function(e){console.error(e)}))}),jQuery(document).on("click",".bp-messages-call-controls .bpbm-reject",function(e){e.preventDefault();var s=jQuery(this).data("user-id");i(),M.emit("mediaEvent",{event:"rejected",to:s}),M.emit("mediaEvent",{event:"self_reject",to:BP_Messages.user_id}),j[s]="1",setTimeout(function(){delete j[s]},3e3),t()}),jQuery(document).on("click",".bp-messages-call-controls .bpbm-cancel",function(s){s.preventDefault();var a=e(this).closest(".bp-messages-video-container");M.emit("mediaEvent",{event:"call_cancelled",to:d.participant,thread_id:a.data("thread-id")}),t()}),jQuery(document).on("click",".bp-messages-call-controls .bpbm-call-end",function(e){e.preventDefault(),M.emit("mediaEvent",{event:"call_end",to:d.participant}),t()}),jQuery(document).on("click",".bp-messages-wrap.bp-messages-popup .bpbm-answer",function(e){e.preventDefault();var s=jQuery(this).data("thread-id");location.href=BP_Messages.threadUrl+s}),jQuery(document).on("click",".bp-messages-wrap.bp-messages-popup .bpbm-reject",function(s){s.preventDefault();var a=jQuery(this).data("user-id");e(this).closest(".amaran.incoming_call").remove(),i(),M.emit("mediaEvent",{event:"rejected",to:a}),M.emit("mediaEvent",{event:"self_reject",to:BP_Messages.user_id}),j[a]="1",setTimeout(function(){delete j[a]},3e3),t()}),M.on("getUnread",function(s){var t=e('.bp-better-messages-list > .tabs > div[data-tab="messages"]'),a=0,i=0,n=e(".bp-messages-wrap .threads-list").length;Object.keys(s.threads).length>0?(e.each(s.threads,function(s){f(s,this),I[s]=this,a+=parseInt(this),i++,n>0&&0===e('.bp-messages-wrap .threads-list .thread[data-id="'+s+'"]').length&&M.emit("threadOpen",s)}),n>0&&e(".bp-messages-wrap .threads-list .thread[data-id]").each(function(){var t=e(this).data("id");void 0===s.threads[t]&&f(t,0)})):(a=0,e(".threads-list .thread, .bp-better-messages-mini .chat").removeClass("unread"),e(".threads-list .thread .time .unread-count").text(""),e(".bp-better-messages-mini .chat .unread-count").attr("class","unread-count count-0").text(""),I={}),a>0?(t.find(".fas").hide(),t.find(".unread-count").text(a).show()):(t.find(".fas").show(),t.find(".unread-count").text("").hide()),e(document).trigger("bp-better-messages-update-unread",i)}),M.on("message_deleted",function(e){s([e])}),M.on("onlineUsers",function(e){T=e,c()}),M.on("userOnline",function(s){-1===T.indexOf(s)&&(T.push(s),e('.bbpm-avatar[data-user-id="'+s+'"]').addClass("online"))}),M.on("userOffline",function(s){T.indexOf(s)>-1&&(T.splice(T.indexOf(s),1),e('.bbpm-avatar[data-user-id="'+s+'"]').removeClass("online"))}),M.on("message",function(s){var t='.bp-better-messages-mini .chats .chat[data-thread="'+s.thread_id+'"]',a=e(t),i=e('.bp-better-messages-mini .chats .chat[data-thread="'+s.thread_id+'"].open');s.fast||"1"!=BP_Messages.realtime||(BP_Messages.user_id!=s.user_id?ifvisible.now("active")&&(!1!==B||i.length>0)?(M.emit("seen",[s.id]),M.emit("threadOpen",s.thread_id),w("bp-better-messages-thread-"+s.thread_id,s.timestamp,1)):M.emit("delivered",s.id):w("bp-better-messages-thread-"+s.thread_id,s.timestamp,1)),m(s),B==s.thread_id?p(s):y?a.length>0&&p(s,t):a.length>0?p(s,t):BP_Messages.user_id==s.user_id||s.fast||g(s.thread_id,s.content_site,s.name,s.avatar)}),"1"==BP_Messages.realtime&&(M.on("delivered",function(s,t){var a=e('.bp-messages-wrap .list .messages-stack .content .messages-list li[data-id="'+s+'"]');a.removeClass("sent"),a.addClass("delivered"),a.find(".status").attr("title",BP_Messages.strings.delivered)}),M.on("seen",function(s,t){var a=e('.bp-messages-wrap .list .messages-stack .content .messages-list li[data-id="'+s+'"]');a.removeClass("delivered sent"),a.addClass("seen"),a.find(".status").attr("title",BP_Messages.strings.seen)})),M.on("writing",function(s){if("object"==typeof s){var t={};e.each(s,function(s){void 0===t[s]&&(t[s]=[]);var a=e('.bp-messages-wrap .thread[data-id="'+s+'"][data-users-json').data("users-json");"object"==typeof a&&t[s].push(a[this].name)}),e.each(t,function(s){!function(){var s=e("span.writing"),t=e(".bp-messages-wrap .reply").outerHeight();s.css("bottom",t)}();var t=e('.bp-messages-wrap .thread[data-id="'+s+'"]').parents(".bp-messages-wrap");if(t.hasClass("bp-better-messages-mini"))a=t.find('.chat[data-thread="'+s+'"] span.writing');else var a=t.find("span.writing");a.attr("data-time",Date.now()),a.addClass("shown"),a.html(this.join(", ")+" "+BP_Messages.strings.writing),a.show()})}}),setInterval(function(){var s=e("span.writing.shown");if(0===s.length)return!1;s.each(function(){parseInt(e(this).attr("data-time"))+1e3<Date.now()&&e(this).hide().removeClass("shown")})},1e3);var Q={};C.on("keyup",".reply .bp-emojionearea-editor",function(s){var t=e(this).parent().parent().parent().parent().parent(),a=t.find(".thread[data-id]").data("id");void 0===Q[a]&&(Q[a]=0),s.which<=90&&s.which>=48&&(0===Q[a]||Q[a]+1e3<Date.now())&&(Q[a]=Date.now(),M.emit("writing",a,t.find(".thread[data-users]").attr("data-users")))}),C.on("keyup",".reply textarea",function(s){var t=e(this).parent().parent().parent().parent().parent(),a=t.find(".thread[data-id]").data("id");void 0===Q[a]&&(Q[a]=0),s.which<=90&&s.which>=48&&(0===Q[a]||Q[a]+1e3<Date.now())&&(Q[a]=Date.now(),M.emit("writing",a,t.find(".thread[data-users]").attr("data-users")))}),"1"==BP_Messages.realtime&&ifvisible.on("wakeup",function(){var s=[],t=[];e(".bp-messages-wrap:not(.bp-better-messages-mini) .list .messages-stack .content .messages-list li.unread:not(.fast),.bp-messages-wrap.bp-better-messages-mini .chat.open .list .messages-stack .content .messages-list li.unread:not(.fast)").each(function(){var a=e(this).data("id"),i=e(this).data("thread"),n=e(this).attr("data-time");s.push(a),t.push(i),e(this).removeClass("unread"),w("bp-better-messages-thread-"+i,n,1)}),s.length>0&&M.emit("seen",s),t=a(t),e.each(t,function(){M.emit("threadOpen",this)})})}function a(s){var t=[];return e.each(s,function(s,a){-1===e.inArray(a,t)&&t.push(a)}),t}function i(){function s(s,t){if("undefined"==typeof event)return!1;var a=e(event.target).attr("data-id"),n=e(event.target).hasClass("threads-list-wrapper");void 0===S[a]&&(S[a]=!1),s.scroll<=10&&a&&!1===S[a]&&function(s){if(void 0!==Q[s])return!1;e('.bp-messages-wrap .thread[data-id="'+s+'"] .loading-messages').show(),Q[s]=!0;var t=e('.bp-messages-wrap .thread[data-id="'+s+'"] .messages-stack:first-child .messages-list li:first-child').attr("data-id");e.post(BP_Messages.ajaxUrl,{action:"bp_messages_thread_load_messages",thread_id:s,message_id:t},function(t){e('.bp-messages-wrap .thread[data-id="'+s+'"] .loading-messages').hide(),""===t.trim()&&(S[s]=!0);var a=0;e('.bp-messages-wrap .thread[data-id="'+s+'"] .list .messages-stack').each(function(){a+=e(this).outerHeight()}),e(t).prependTo('.bp-messages-wrap .thread[data-id="'+s+'"] .list');var n=0;e('.bp-messages-wrap .thread[data-id="'+s+'"] .list .messages-stack').each(function(){n+=e(this).outerHeight()}),e('.bp-messages-wrap .thread[data-id="'+s+'"]').scrollTop(n-a),i(),delete Q[s]})}(a),n&&s.maxScroll-s.scroll<=25&&function(s){var t=e(s);if(t.hasClass("loading-more")||t.hasClass("all-loaded"))return!1;t.addClass("loading-more"),t.find(".loading-messages").show();var a=[],i=t.find(".loading-messages");t.find(".threads-list > .thread").each(function(){a.push(e(this).data("id"))}),e.post(BP_Messages.ajaxUrl,{action:"bp_messages_get_more_threads",loaded_threads:a},function(s){e(s).insertBefore(i),t.removeClass("loading-more"),t.find(".loading-messages").hide(),""===s.trim()&&t.addClass("all-loaded")})}(event.target)}function t(){var s=e(window).height()-50,t=e("#wpadminbar");t.length>0&&t.is(":visible")&&(s-=t.height()),s>BP_Messages.max_height&&(s=BP_Messages.max_height),jQuery(".scroll-wrapper, .bp-better-messages-list, .bp-better-messages-mini").css("max-height",s)}B=!1,y=!1,E=!0,clearTimeout(P),e(".wp-audio-shortcode, .wp-video-shortcode").not(".mejs-container").filter(function(){return!e(this).parent().hasClass(".mejs-mediaelement")}).mediaelementplayer(),e(document).trigger("bp-better-messages-update-unread",BP_Messages.total_unread),l(),c(),e(".bp-messages-wrap:not(.bp-better-messages-mini,.bp-better-messages-list) .thread.scroller[data-users-json]").length>0?B=e(".bp-messages-wrap:not(.bp-better-messages-mini,.bp-better-messages-list) .thread.scroller[data-users-json]").attr("data-id"):e(".bp-messages-wrap:not(.bp-better-messages-mini,.bp-better-messages-list,#bp-better-messages-mini-mobile-container) .threads-list").length>0&&(y=!0),P=B?setTimeout(o,BP_Messages.threadRefresh):setTimeout(r,BP_Messages.siteRefresh),"1"==BP_Messages.miniChats&&e.each(x,function(s){s!==B?b(s,this):e('.bp-messages-wrap.bp-better-messages-mini .chats .chat[data-thread="'+B+'"]').remove()}),!1!==D&&(e('.bp-better-messages-list .tabs > div[data-tab="'+D+'"]').addClass("active"),e(".bp-better-messages-list .tabs-content ."+D).addClass("active")),H||e(".bp-messages-wrap .reply .message textarea, .bp-messages-wrap .new-message #message-input, .bp-messages-wrap .bulk-message #message-input").BPemojioneArea({autocomplete:!1});var d={onScroll:s,disableBodyScroll:!1,stepScrolling:!1};if(jQuery(".scrollbar-inner").scrollbar(d),jQuery(".scrollbar-inner").scroll(function(t){var a=e(this).scrollTop(),i=e(this).prop("scrollHeight"),n=e(this).height();s({size:i,visible:n,maxScroll:i-n,scroll:a})}),e(".bp-messages-wrap .list .messages-stack .content .messages-list li .images").magnificPopup({delegate:"a",type:"image"}),0===e(".bp-messages-wrap > .search, .bp-messages-wrap > .starred").length&&(H?d.onInit=setTimeout(n,500):n()),"1"==BP_Messages.realtime){var m=[],p=[];e(".bp-messages-wrap:not(.bp-better-messages-mini,.bp-better-messages-list) .list .messages-stack .content .messages-list li:not(.seen), .bp-messages-wrap.bp-better-messages-mini .chat.open .list .messages-stack .content .messages-list li:not(.seen)").each(function(){var s=e(this).data("id"),t=e(this).data("thread");m.push(s),p.push(t)}),M.emit("getStatuses",m,function(s){e.each(s,function(s){var t=e('.bp-messages-wrap .list .messages-stack .content .messages-list li[data-id="'+s+'"]');if(t.removeClass("sent delivered seen"),t.hasClass("my")||t.hasClass("fast")){var a="sent";e.each(this,function(){if("seen"==a)return!1;"delivered"==this&&"seen"!=a&&(a="delivered"),"seen"==this&&(a="seen")}),t.addClass(a);var i="";switch(a){case"sent":i=BP_Messages.strings.sent;break;case"delivered":i=BP_Messages.strings.delivered;break;case"seen":i=BP_Messages.strings.seen}t.find(".status").attr("title",i)}else"seen"!==this.toString()&&M.emit("seen",[s])})}),B&&M.emit("threadOpen",B),p=a(p),e.each(p,function(){M.emit("threadOpen",this)}),M.emit("requestUnread")}if(C.hasClass("bp-messages-mobile")){var g=window.innerHeight,h=0;h+=C.find(".chat-header").outerHeight(),h+=C.find(".reply").outerHeight(),e(".scroll-wrapper").css("height",g-h)}else t(),e(window).resize(function(){t()});if(e(".bp-messages-wrap #send-to:not(.ready)").length>0){var u=[],f=new Taggle("send-to",{placeholder:"",tabIndex:2,hiddenInputName:"recipients[]"}),v=f.getContainer(),w=f.getInput(),_=e('input[name="to"]');_.length>0&&e(_).each(function(){var s=e(this).data("img"),t=e(this).data("label");f.add(e(this).val()),e(v).find(".taggle_sizer").text(""),e("#send-to li.taggle:last .taggle_text").html('<span class="bpbm-avatar"><img src="'+s+'" class="avatar photo" width="50" height="50"></span><span class="bpbm-name">'+t+"</span>"),e(this).remove()}),e(w).on("blur",function(s){var t=e(v).find(".taggle_sizer").text();f.add(t)}),e(w).autocomplete({source:function(s,t){var a=s.term;a in u?t(u[a]):e.getJSON(BP_Messages.ajaxUrl+"?q="+a+"&limit=10&action=bp_messages_autocomplete&cookie="+function(){var e,s,t,a,i,n=document.cookie.split(";"),r={};for(e=0;e<n.length;e++)s=n[e],t=s.indexOf("="),a=jQuery.trim(unescape(s.slice(0,t))),i=unescape(s.slice(t+1)),0===a.indexOf("bp-")&&(r[a]=i);return encodeURIComponent(jQuery.param(r))}(),s,function(e,s,i){u[a]=e,t(e)})},minLength:2,appendTo:v,position:{at:"left bottom",of:v},open:function(s,t){var a=e(".bp-messages-wrap #send-to .ui-autocomplete"),i=parseInt(a.css("top"))-3;a.css("top",i)},select:function(s,t){s.preventDefault(),1===s.which&&(f.add(t.item.value),e(v).find(".taggle_sizer").text(""),e("#send-to li.taggle:last .taggle_text").html('<span class="bpbm-avatar">'+t.item.img+'</span><span class="bpbm-name">'+t.item.label+"</span>"))},response:function(s,t){e(".ui-helper-hidden-accessible").hide()}}).autocomplete("instance")._renderItem=function(s,t){return e("<li>").attr("data-value",t.value).attr("data-label",t.label).append('<span class="bpbm-avatar">'+t.img+'</span><span class="bpbm-name">'+t.label+"</span>").appendTo(s)},e("#send-to").addClass("ready")}C.find(".bp-messages-mobile-tap").css("line-height",C.height()+"px"),e(document.body).trigger("post-load"),E=!1}function n(s){if(void 0===s&&(s=".bp-messages-wrap:not(.bp-better-messages-mini,.bp-better-messages-list)"),0!=e(s+" .list").length){var t=e(s+" .scroller[data-id]").data("id");if(void 0!==Q[t])return!1;var a=e(s+" .list")[0].offsetHeight;if(k("message_id").length>0){var i=k("message_id"),n=e(s+" .messages-list li[data-id='"+i+"']");n.length>0&&(a=n[0].offsetTop-n[0].offsetHeight-100)}e(s+" .scroller").scrollTop(parseInt(a)+100)}}function r(){if(clearInterval(P),P=setTimeout(r,BP_Messages.siteRefresh),"1"!=BP_Messages.realtime&&!z){var s=_("bp-messages-last-check");z=!0,e.post(BP_Messages.ajaxUrl,{action:"bp_messages_check_new",last_check:s},function(s){s.threads.length>0&&e.each(s.threads,function(){y?m(this):g(this.thread_id,this.message,this.name,this.avatar)}),e(document).trigger("bp-better-messages-update-unread",s.total_unread),z=!1})}}function o(){if(clearInterval(P),P=setTimeout(o,BP_Messages.threadRefresh),"1"!=BP_Messages.realtime&&!R){var s=_("bp-messages-last-check"),t=e(".messages-stack:last-child .messages-list li:last-child").attr("data-time");R=!0,e.post(BP_Messages.ajaxUrl,{action:"bp_messages_thread_check_new",last_check:s,thread_id:B,last_message:t},function(s){e.each(s.messages,function(){p(this)}),e.each(s.threads,function(){g(this.thread_id,this.message,this.name,this.avatar)}),e(document).trigger("bp-better-messages-update-unread",s.total_unread),R=!1})}}function l(){if(!store.enabled)return!1;j=store.get("bp-better-messages-open-threads")||{},!1!==B&&(j[B]=Date.now()),e.each(j,function(e){this+2e3<Date.now()&&delete j[e]}),store.set("bp-better-messages-open-threads",j)}function d(s,t){void 0===t&&(t=jQuery(event.target).closest(".bp-messages-wrap")),t.hasClass("bp-messages-wrap-main")&&window.history.pushState("","",s),t.find(".preloader").show(),e(window).off(".bp-messages"),e.ajax({method:"GET",url:s,cache:!1,success:function(s){var a=e(s).find(".bp-messages-wrap:not(.bp-better-messages-mini,.bp-better-messages-list)").html();t.html(a),i()}})}function c(){e(".bp-messages-wrap img.avatar[data-user-id]").each(function(){var s=e(this).attr("data-user-id"),t=!1;if(e(this).parent().hasClass("bbpm-avatar")&&(t=e(this).parent()),!t){var a=e(this).height(),i=e(this).height(),n=e(this).css("marginTop"),r=e(this).css("marginLeft"),o=e(this).css("marginBottom"),l=e(this).css("marginRight");e(this).css({marginTop:0,marginLeft:0,marginRight:0,marginBottom:0}),e(this).wrap('<span class="avatar bbpm-avatar" data-user-id="'+s+'"></span>'),(t=e(this).parent()).css({marginTop:n,marginLeft:r,marginRight:l,marginBottom:o,width:a,height:i})}T.indexOf(s)>-1?e(t).addClass("online"):e(t).removeClass("online")})}function m(s){if(s.fast||"1"==s.edit)return!1;e(".bp-messages-wrap .threads-list .empty").remove();var t=s.thread_id;e(".bp-messages-wrap .threads-list .thread[data-id='"+t+"']").remove(),e(".bp-messages-wrap .threads-list").prepend(s.html),BP_Messages.user_id!=s.user_id&&v(s.id),c()}function p(s,t){var a=!1,i=!1;if(void 0===t&&(t=".bp-messages-wrap:not(.bp-better-messages-mini,.bp-better-messages-list)"),""==s.message.trim())return!1;var r="1"==s.edit;"1"!=BP_Messages.realtime||s.fast||(r?(a=!0,s.temp_id=s.id):s.temp_id&&(a=!0));var o=moment(f).format("YYYY-MM-DD HH:mm:ss").toString(),l=e(t+" .messages-stack:last-child");0===l.length&&e(t+" .empty-thread").length>0&&(i=!0);var d=e(t+' .messages-list li[data-id="'+s.id+'"]'),m="";ifvisible.now("active")||"1"!=BP_Messages.realtime||(m+=" unread"),s.user_id==BP_Messages.user_id&&(m+=" my"),s.fast&&(m+=" fast"),s.user_id==BP_Messages.user_id&&"1"==BP_Messages.realtime&&(m+=" sent"),m=m.trim();var p=e(t+' .messages-list li[data-id="'+s.temp_id+'"]');r&&p.length>0&&(m=p.attr("class"));var g='<li class="'+m+'" data-thread="'+s.thread_id+'" title="'+o+'" data-time="'+s.timestamp+'" data-id="'+s.id+'"><span class="favorite"><i class="fas" aria-hidden="true"></i></span>';if(s.user_id==BP_Messages.user_id&&(g+='<span class="status" title="'+BP_Messages.strings.sent+'"></span>'),g+='<span class="message-content">'+s.message+"</span></li>",a&&p.length>0)return s.message!==p.find(".message-content").html()?p.replaceWith(g):(p.attr("data-id",s.id),p.removeClass("fast")),!0;if(0===d.length&&(l.length>0||i)){1==i&&e(t+" .empty-thread").remove();var h=!0,u=new Date(1e3*l.find(".messages-list > li:last-child").attr("data-time")),b=u.getFullYear()+"-"+u.getMonth()+"-"+u.getDate()+"-"+u.getHours()+"-"+u.getMinutes(),f=new Date(1e3*s.timestamp),w=f.getFullYear()+"-"+f.getMonth()+"-"+f.getDate()+"-"+f.getHours()+"-"+f.getMinutes();if(l.attr("data-user-id")===s.user_id&&(h=!1),b!==w&&(h=!0),!1===h)l.find(".messages-list").append(g);else{var _="messages-stack";s.user_id==BP_Messages.user_id?_+=" outgoing":_+=" incoming";var k='<div class="'+_+'" data-user-id="'+s.user_id+'"><div class="pic">'+s.avatar+'</div><div class="content"><div class="info"><div class="name"><a href="'+s.link+'">'+s.name+'</a></div><div class="time" title="'+o+'" data-livestamp="'+s.timestamp+'"></div></div><ul class="messages-list"></ul></div></div>';e(t+" .list").append(k),e(t+" .messages-stack:last-child .messages-list").append(g)}parseInt(e(t+" .scroller[data-users] .list").outerHeight())-parseInt(e(t+" .scroller[data-users]").outerHeight())-parseInt(e(t+" .scroller[data-users]").scrollTop())<100&&n(t),e(t+" .wp-audio-shortcode, "+t+" .wp-video-shortcode").not(".mejs-container").filter(function(){return!e(this).parent().hasClass(".mejs-mediaelement")}).mediaelementplayer(),e(".bp-messages-wrap .list .messages-stack .content .messages-list li .images").magnificPopup({delegate:"a",type:"image"}),BP_Messages.user_id!=s.user_id&&v(s.id)}c()}function g(s,t,a,i){if(void 0===j[s]&&!e("body").hasClass("bp-messages-mobile")){var n=i.match(/src\="([^\s]*)"\s/),r=i.match(/src\='([^\s]*)'\s/);null!=n&&(i=n[1]),null!=r&&(i=r[1]);var o=e(".amaran.thread_"+s);if(o.length>0){o.find(".icon > img").attr("src",i);var l="<b>"+a+"</b>";return l+=t,o.find(".info").html(l),!0}"1"==BP_Messages.miniMessages&&"messages"===D||e.amaran({theme:"user message thread_"+s,content:{img:i,user:a,message:t},sticky:!0,closeOnClick:!1,closeButton:!0,delay:1e4,thread_id:s,position:"bottom right",onClick:function(){if("1"!=BP_Messages.realtime||"1"!=BP_Messages.miniChats||H)if(H){var t=e("#bp-better-messages-mini-mobile-open");if(t.length>0){var a=BP_Messages.url;BP_Messages.url=BP_Messages.threadUrl+this.thread_id,t.click(),BP_Messages.url=a,e(".amaran.user.message.thread_"+s).remove()}else location.href=BP_Messages.threadUrl+this.thread_id}else location.href=BP_Messages.threadUrl+this.thread_id;else b(this.thread_id,!0),e(".amaran.user.message.thread_"+s).remove()}}),v(t.id)}}function h(s){var t=e("#bp-better-messages-mini-mobile-container");t.addClass("bp-messages-mobile"),t.find(".bp-messages-mobile-tap").remove();var a=window.innerHeight;e("html").css("overflow","hidden"),e("body").addClass("bp-messages-mobile").css("min-height",a),C.addClass("bp-messages-mobile").css("min-height",a);var r=0;r+=C.find(".chat-header").outerHeight();var o=a-(r+=C.find(".reply").outerHeight());e(".scroller").css({"max-height":"",height:o}),t.show().html('<div class="loading-messages" style="display: block;line-height: '+o+'px">\n<div class="bounce1"></div>\n<div class="bounce2"></div>\n<div class="bounce3"></div>\n</div>'),e.get(s,function(s){var a=e(s).find(".bp-messages-wrap:not(.bp-better-messages-mini,.bp-better-messages-list)").html();t.html(a).show(),n(),blockScroll=!0,i(),e("#bp-better-messages-mini-mobile-open").removeClass("loading")})}function u(s){var t=new e.Deferred;return e.post(BP_Messages.ajaxUrl,{action:"bp_messages_get_pm_thread",user_id:s},function(e){if(H&&"1"===BP_Messages.mobileFullScreen)BP_Messages.threadUrl;else b(e,!0).always(function(e){t.resolve(!0)})}),t.promise()}function b(s,t){var a=new e.Deferred;if("1"!=BP_Messages.miniChats||N.indexOf(s)>-1)a.reject(!1);else{var r=e('.bp-messages-wrap.bp-better-messages-mini .chats .chat[data-thread="'+s+'"]');if(r.length>0){if(!E){var o=r.find(".head");r.addClass("open"),r.removeClass("blink");var l=0,d=setInterval(function(){o.toggleClass("blink"),++l>=6&&clearInterval(d)},500)}a.reject(!1)}else{N.push(s);var c=BP_Messages.threadUrl+s+"&mini=1";e.get(c,function(r){var o=e(r).find(".bp-messages-wrap.bp-messages-wrap-main"),l=o.find(".chat-header").text().trim();o.find(".chat-header, .preloader").remove();var d="chat";1==t&&(d+=" open");var c='<div class="'+d+'" data-thread="'+s+'" style="visibility: hidden">';c+='<div class="head"><span class="unread-count count-0"></span><span class="title">'+l+"</span>",c+='<div class="controls">\n<span class="open"><i class="fas fa-window-maximize" aria-hidden="true"></i></span>\n<span class="close"><i class="fas fa-times" aria-hidden="true"></i></span>\n</div></div>',c+=o.html(),e(c+="</div>").appendTo(".bp-messages-wrap.bp-better-messages-mini .chats"),x[s]=t,store.set("bp-better-messages-mini-chats",x),delete N[N.indexOf(s)],i(),!0===t&&M.emit("threadOpen",s),clearTimeout(A),A=setTimeout(function(){e(".bp-messages-wrap.bp-better-messages-mini .chats .chat").each(function(){var s=e(this).data("thread");parseInt(e(".bp-messages-wrap.bp-better-messages-mini").outerHeight())-parseInt(e(this).position().top+e(this).outerHeight())>1&&(e(this).remove(),void 0!==x[s]&&delete x[s],store.set("bp-better-messages-mini-chats",x))}),e(".bp-messages-wrap.bp-better-messages-mini .chats .chat").css("visibility","visible")},100),n('.bp-messages-wrap.bp-better-messages-mini .chats .chat[data-thread="'+s+'"]'),a.resolve(!0)})}}return a.promise()}function f(s,t){var a;t<1?(a="",e('.threads-list .thread[data-id="'+s+'"], .bp-better-messages-mini .chat[data-thread="'+s+'"]').removeClass("unread"),e('.bp-messages-wrap .messages-list li[data-thread="'+s+'"]').removeClass("unread")):(a="+"+t,e('.threads-list .thread[data-id="'+s+'"], .bp-better-messages-mini .chat[data-thread="'+s+'"]').addClass("unread")),e('.threads-list .thread[data-id="'+s+'"] .time .unread-count').text(a),e('.bp-better-messages-mini .chat[data-thread="'+s+'"] .unread-count').attr("class","unread-count count-"+t).text(t)}function v(e){"string"==typeof e&&"tmp_"!==e.substr(0,4)&&ion.sound.play("notification")}function w(e,s,t){if(t){var a=new Date;a.setTime(a.getTime()+24*t*60*60*1e3);i="; expires="+a.toUTCString()}else var i="";document.cookie=e+"="+s+i+"; path=/"}function _(e){for(var s=e+"=",t=document.cookie.split(";"),a=0;a<t.length;a++){for(var i=t[a];" "==i.charAt(0);)i=i.substring(1,i.length);if(0==i.indexOf(s))return i.substring(s.length,i.length)}return null}function k(e){var s="[\\?&]"+(e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]"))+"=([^&#]*)",t=new RegExp(s).exec(window.location.search);return null==t?"":decodeURIComponent(t[1].replace(/\+/g," "))}var P,B,M,y,C,j={},x={},D=!1,T=[],Q={},S={},I={},E=!1,U=window.RTCPeerConnection||window.webkitRTCPeerConnection,O=window.mozRTCSessionDescription||window.RTCSessionDescription;navigator.webkitGetUserMedia;ifvisible.setIdleDuration(3),e(window).focus(function(){ifvisible.focus()}),e(window).blur(function(){ifvisible.blur()});var H=!1;(/iPad|iPhone|iPod/.test(navigator.userAgent)||/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigator.userAgent.substr(0,4)))&&(H=!0),"0"===BP_Messages.mobileFullScreen&&(H=!1),e(document).ready(function(){function a(s){var t=window.innerHeight;e("html").css("overflow","hidden"),e("body").addClass("bp-messages-mobile").css("min-height",t),s.addClass("bp-messages-mobile").css("min-height",t);var a=0;a+=s.find(".chat-header").outerHeight();var i=t-(a+=s.find(".reply").outerHeight());e(".scroller").css({"max-height":"",height:i}),n(),p=!0}function r(){if(g)return!1;var s=window.innerHeight,t=0;t+=C.find(".chat-header").outerHeight(),t+=C.find(".reply").outerHeight(),e(".scroller").css({"max-height":"",height:s-t})}C=e(".bp-messages-wrap:not(.bp-better-messages-list, #bp-better-messages-mini-mobile-open)");var c=e("#bp-better-messages-mini-mobile-container"),m=e("#bp-better-messages-mini-mobile-open");if(ion.sound({sounds:[{name:"calling"},{name:"notification"}],path:BP_Messages.assets+"sounds/",preload:!0,multiplay:!0,volume:.75}),H){var p=!1,g=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;e(document).on("touchmove",".bp-messages-wrap .chat-header,.bp-messages-wrap .reply",function(e){p&&e.preventDefault()}),e(document).on("focus blur",".bp-messages-wrap textarea, .bp-messages-wrap input",function(e){setTimeout(function(){r(),n()},300)}),e(window).resize(function(){C.hasClass("bp-messages-mobile")&&r()}),C.addClass("mobile-ready");var f,v=!1;"0"===BP_Messages.disableTapToOpen?(C.find(".bp-messages-mobile-tap").css("line-height",C.height()+"px"),C.on("touchend",".bp-messages-mobile-tap",function(e){if(1!=f&&!1===v){var s=jQuery(e.target).closest(".bp-messages-wrap");s.hasClass("bp-messages-mobile")||(e.preventDefault(),e.stopImmediatePropagation(),a(s))}}).on("touchmove",function(e){f=!0}).on("touchstart",function(e){f=!1})):C.on("touchend",function(s){if(1!=f&&!1===v){var t=jQuery(s.target).closest(".bp-messages-wrap");if(!t.hasClass("bp-messages-mobile")){s.preventDefault(),s.stopImmediatePropagation(),a(t);var i=e(s.originalEvent.target).closest(".thread");i.length>0&&i.click()}}}).on("touchmove",function(e){f=!0}).on("touchstart",function(e){f=!1}),e(document).on("click",".bp-messages-wrap .mobileClose",function(s){var t=jQuery(s.target).closest(".bp-messages-wrap");if(t.hasClass("bp-messages-mobile")){s.preventDefault(),s.stopImmediatePropagation(),v=!0,e("html").css("overflow","auto"),t.removeClass("bp-messages-mobile").css("min-height",""),e("body").removeClass("bp-messages-mobile").css("min-height","");var a=e(window).height()-250;a>BP_Messages.max_height&&(a=BP_Messages.max_height),e(".scroller").css({"max-height":a,height:""}),p=!1,t.find(".bp-messages-mobile-tap").css("line-height",t.height()+"px"),t.is(c)&&c.hide(),setTimeout(function(){v=!1},100)}})}m.click(function(e){e.preventDefault(),m.hasClass("loading")||(m.addClass("loading"),h(BP_Messages.url))});var _=!1,k=!1;if(e(".bp-messages-wrap:not(.bp-better-messages-mini,.bp-better-messages-list) .thread.scroller[data-users-json]").length>0?_=e(".bp-messages-wrap:not(.bp-better-messages-mini,.bp-better-messages-list) .thread.scroller[data-users-json]").attr("data-id"):e(".bp-messages-wrap:not(.bp-better-messages-mini,.bp-better-messages-list,#bp-better-messages-mini-mobile-container) .threads-list").length>0&&(k=!0),(_||k)&&(e("#bp-better-messages-mini-mobile-open, #bp-better-messages-mini-mobile-container").remove(),H&&"1"===BP_Messages.autoFullScreen)){a(e(".bp-messages-wrap.bp-messages-wrap-main.mobile-ready"))}"1"===BP_Messages.blockScroll&&e(".bp-messages-wrap").on("mousewheel DOMMouseScroll",".scroll-content",function(s){var t=s.originalEvent,a=t.wheelDelta||-t.detail,i=s.currentTarget.scrollHeight-e(s.currentTarget).height();this.scrollTop+=5*(a<0?1:-1),(this.scrollTop<5||i-this.scrollTop<5)&&s.preventDefault()}),store.enabled&&(j=store.get("bp-better-messages-open-threads")||{},x=store.get("bp-better-messages-mini-chats")||{},D=store.get("bp-better-messages-mini-messages")||!1,setInterval(l,1e3)),"1"==BP_Messages.realtime&&t(),i(),setInterval(function(){e.post(BP_Messages.ajaxUrl,{action:"bp_messages_last_activity_refresh"})},3e5),C.on("click",".threads-list .thread:not(.blocked)",function(s){if(0===e(s.target).closest(".pic").length&&0===e(s.target).closest(".delete").length&&0===e(s.target).closest(".deleted").length){s.preventDefault();d(e(this).attr("data-href"))}}),e(document).on("click",".bp-messages-wrap .threads-list .thread span.delete",function(s){s.preventDefault(),s.stopPropagation();var t=e(this).parent().parent(),a=(t.parent().parent(),e(t).attr("data-id")),i=e(t).height(),n=e(this).attr("data-nonce");e.post(BP_Messages.ajaxUrl,{action:"bp_messages_delete_thread",thread_id:a,nonce:n},function(s){if(s.result){var a=t.position().top;e(t).addClass("blocked"),e(t).find(".deleted").show().css({height:i,"line-height":i+"px",top:a+"px"})}else BBPMShowError(s.errors[0])})}),e(document).on("click",".bp-messages-wrap .threads-list .thread a.undelete",function(s){s.preventDefault(),s.stopPropagation();var t=e(this).parent().parent(),a=e(t).attr("data-id");e(t).removeClass("blocked");var i=e(this).attr("data-nonce");e.post(BP_Messages.ajaxUrl,{action:"bp_messages_un_delete_thread",thread_id:a,nonce:i},function(s){s.result?(e(t).removeClass("blocked"),e(t).find(".deleted").hide()):BBPMShowError(s.errors[0])})}),C.on("click",".messages-list li .favorite",function(s){s.preventDefault(),s.stopPropagation();var t=e(this).parentsUntil(".messages-list","li").attr("data-id"),a="star";e(this).hasClass("active")&&(a="unstar"),e(this).toggleClass("active"),e.post(BP_Messages.ajaxUrl,{action:"bp_messages_favorite",message_id:t,thread_id:B,type:a},function(e){})});var P,y=!1,T="";C.on("submit",".reply > form",function(s){s.preventDefault(),s.stopPropagation();var t=e(this),a=e(this).serialize();if(a===T)return!1;if(!0!==y){y=!0;var i=B,n=e(this).find('input[name="message_id"]').val().trim().length>0,r=e(this).find('textarea[name="message"]').val(),l=e.parseJSON(e(this).parent().parent().find(".thread.scroller[data-users-json]").attr("data-users-json"));e(this).parent().parent().hasClass("chat open")&&(i=e(this).parent().parent().attr("data-thread")),i&&"1"==BP_Messages.realtime&&!n?M.emit("message",i,r,l,function(s){y=!1,T=a,clearInterval(P),P=setInterval(function(){T=""},3e3),e(document).trigger("bp-better-messages-message-sent"),t.find('input[name="message_id"]').val(""),editing=!1,a+="&tempID="+s,e.post(BP_Messages.ajaxUrl,a,function(s){void 0!==s.result&&e.each(s.errors,function(){BBPMShowError(this)})})}):e.post(BP_Messages.ajaxUrl,a,function(s){y=!1,void 0!==s.result&&(s.result?(o(),e(document).trigger("bp-better-messages-message-sent"),T=a,clearInterval(P),P=setInterval(function(){T=""},3e3),t.find('input[name="message_id"]').val(""),editing=!1):e.each(s.errors,function(){BBPMShowError(this)}))}),e(this).find("textarea, .bp-emojionearea-editor").html("").val("")}}),C.on("submit",".new-message form",function(s){s.preventDefault(),s.stopPropagation();var t=jQuery(s.target).closest(".bp-messages-wrap");e(".bp-messages-wrap:not(.bp-better-messages-mini,.bp-better-messages-list) .preloader").show(),e.post(BP_Messages.ajaxUrl,e(this).serialize(),function(s){s.result?d(BP_Messages.threadUrl+s.result,t):(e(".bp-messages-wrap:not(.bp-better-messages-mini,.bp-better-messages-list) .preloader").hide(),e.each(s.errors,function(){BBPMShowError(this)}))})}),C.on("click","a.ajax",function(s){s.preventDefault(),s.stopPropagation();d(e(this).attr("href"))}),C.on("click",".bpbm-search a.search",function(s){s.preventDefault(),s.stopPropagation(),e(this).hide(),e(".bpbm-search form").show(),e(".bpbm-search form input").focus(),H&&e(".bp-messages-wrap .chat-header .settings").hide()}),C.on("click",".bpbm-search form span.close",function(s){s.preventDefault(),s.stopPropagation(),e(".bpbm-search form").hide(),e(".bpbm-search a.search").show(),e(".bpbm-search form input").val(""),H&&e(".bp-messages-wrap .chat-header .settings").show()}),C.on("submit",".bpbm-search form",function(s){s.preventDefault(),d(BP_Messages.url+"?"+e(this).serialize())}),!1===("1"===BP_Messages.disableEnterForTouch&&H||"1"===BP_Messages.disableEnterForDesktop&&!H)&&C.on("keydown",".reply .bp-emojionearea-editor",function(s){s.shiftKey||13!=s.keyCode||(s.preventDefault(),e(this).blur(),e(this).parent().parent().trigger("submit"),e(this).focus())}),C.on("change",".new-message .send-to-input",function(s){s.preventDefault(),s.stopPropagation();d(e(this).attr("href"))}),H?C.on("touchend",".scroll-wrapper.starred .messages-list li, .scroll-wrapper.search .messages-list li",function(s){if(1!=f&&!1===v){s.preventDefault(),s.stopPropagation();var t=e(this).attr("data-thread"),a=e(this).attr("data-id");d(BP_Messages.threadUrl+t+"&message_id="+a)}}).on("touchmove",function(e){f=!0}).on("touchstart",function(e){f=!1}):C.on("click",".scroll-wrapper.starred .messages-list li, .scroll-wrapper.search .messages-list li",function(s){s.preventDefault(),s.stopPropagation();var t=e(this).attr("data-thread"),a=e(this).attr("data-id");d(BP_Messages.threadUrl+t+"&message_id="+a)}),C.on("click",".participants-panel .bp-messages-user-list .user .actions a.remove-from-thread",function(s){s.preventDefault();var t=e(this).closest(".bp-messages-wrap"),a=e(this).parent().parent(),i=a.data("id"),n=a.data("thread-id"),r=a.find(".name").text();confirm("Exclude "+r+" from this thread?")&&e.post(BP_Messages.ajaxUrl,{action:"bp_better_messages_exclude_user_from_thread",user_id:i,thread_id:n},function(s){if(!0===s.result){d(BP_Messages.url+"?"+e.param({thread_id:n,participants:"1"}),t)}})}),C.on("click",".participants-panel .add-user button",function(s){s.preventDefault();var t=e(this).closest(".bp-messages-wrap"),a=e(this).parent(),i=a.data("thread-id"),n=[];a.find('input[name="recipients[]"]').each(function(){n.push(e(this).val())}),e.post(BP_Messages.ajaxUrl,{action:"bp_better_messages_add_user_to_thread",users:n,thread_id:i},function(s){d(BP_Messages.url+"?"+e.param({thread_id:i,participants:"1"}),t)})}),"1"===BP_Messages.allowDeleteMessages&&C.on("click",".list .messages-stack.outgoing .content .messages-list li",function(s){(e(s.target).hasClass("message-content")||e(s.target).is("li")||e(s.target).hasClass("images"))&&!e(this).closest(".bp-messages-wrap").hasClass("bp-better-messages-mini")&&function(s,t){void 0===t?e(s).toggleClass("selected"):!0===t?e(s).addClass("selected"):e(s).removeClass("selected");var a=e(s).closest(".bp-messages-wrap"),i=a.find(".chat-controls"),n=a.find(".messages-stack li.selected").length;if(n>0){i.show();var r=!0,o=!0;a.find(".messages-stack.incoming li.selected").length>0&&(r=!1,o=!1),n>1&&(r=!1),r?i.find(".bpbm-edit").show():i.find(".bpbm-edit").hide(),o?i.find(".bpbm-delete").show():i.find(".bpbm-delete").hide()}else i.hide()}(this)}),C.on("click",".chat-controls a.bpbm-delete",function(t){t.preventDefault();var a=e(this).data("wp-nonce"),i=BP_Messages.strings.confirm_delete,n=e(this).closest(".bp-messages-wrap"),r=n.find(".messages-stack li.selected");i=i.replace("%s",r.length);if(confirm(i)){var o=[];e.each(r,function(){o.push(e(this).data("id"))}),e.post(BP_Messages.ajaxUrl,{action:"bp_messages_delete_message",thread_id:B,messages_ids:o,_wpnonce:a},function(e){e.result?(BBPMNotice(e.message),s(o)):BBPMShowError(e.errors[0]),n.find(".chat-controls").hide()})}}),"1"==BP_Messages.miniChats&&(e(document).on("click",".bp-better-messages-mini .chats .chat > .head",function(s){var t=e(this).parent(),a=t.attr("data-thread");if(t.toggleClass("open").hasClass("open")){if(x[a]=!0,n('.bp-messages-wrap.bp-better-messages-mini .chats .chat[data-thread="'+a+'"]'),"1"==BP_Messages.realtime){i();var r=[];e('.bp-messages-wrap.bp-better-messages-mini .chats .chat[data-thread="'+a+'"] .list .messages-stack .content .messages-list li.unread:not(.fast)').each(function(){var s=e(this).data("id"),t=e(this).data("thread"),a=e(this).attr("data-time");r.push(s),e(this).removeClass("unread"),w("bp-better-messages-thread-"+t,a,1)}),M.emit("threadOpen",a),r.length>0&&M.emit("seen",r)}}else x[a]=!1;store.set("bp-better-messages-mini-chats",x)}),e(document).on("click",".bp-better-messages-mini .chats .chat > .head .open",function(s){s.stopImmediatePropagation();var t=e(this).parent().parent().parent(),a=t.attr("data-thread");t.fadeOut(),location.href=BP_Messages.threadUrl+a}),e(document).on("click",".bp-better-messages-mini .chats .chat > .head .close",function(s){s.stopImmediatePropagation();var t=e(this).parent().parent().parent(),a=t.attr("data-thread");t.slideUp(function(){t.remove()}),void 0!==x[a]&&delete x[a],store.set("bp-better-messages-mini-chats",x)}),e(".bp-messages-wrap:not(.bp-better-messages-mini,.bp-better-messages-list)").on("click",".chat-header > .mini-chat",function(s){var t=e(this).parent().parent().find(".thread[data-id]").attr("data-id");void 0!==x[t]&&delete x[t],b(t,!0)})),"1"==BP_Messages.miniMessages&&e(document).on("click",".bp-better-messages-list .threads-list .thread:not(.blocked)",function(s){s.preventDefault();var t=e(this),a=t.data("id");if("1"==BP_Messages.miniChats){var r=t.parent().parent(),o=e(t).height(),l=t.position().top;l+=r.scrollTop(),t.addClass("blocked loading"),e(t).find(".loading").css({height:o,"line-height":o+"px",top:l+"px"}),b(a,!0).always(function(e){i(),n('.bp-messages-wrap.bp-better-messages-mini .chats .chat[data-thread="'+a+'"]'),t.removeClass("blocked loading")})}else location.href=BP_Messages.threadUrl+a}),e(document).on("click",".bp-better-messages-list .tabs > div",function(s){s.preventDefault();var t=e(this).data("tab");e(this).hasClass("active")?(e(this).removeClass("active"),e(".bp-better-messages-list .tabs-content ."+t).removeClass("active"),D=!1):(e(".bp-better-messages-list .tabs > div, .bp-better-messages-list .tabs-content > div").removeClass("active"),e(this).addClass("active"),e(".bp-better-messages-list .tabs-content ."+t).addClass("active"),D=t),store.set("bp-better-messages-mini-messages",D)}),e(document).on("click",".bp-better-messages-list .bp-messages-user-list .user:not(.blocked)",function(s){if(e(s.target).is("div")){s.preventDefault();var t=e(this),a=e(this).data("id"),i=e(this).data("username");if("1"==BP_Messages.miniChats&&"1"==BP_Messages.fastStart){var n=t.parent().parent(),r=e(t).height(),o=t.position().top;o+=n.scrollTop(),e(t).find(".loading").css({height:r,"line-height":r+"px",top:o+"px"}),t.addClass("blocked loading"),u(a).always(function(e){t.removeClass("blocked loading")})}else{var l=BP_Messages.url+"?new-message&to="+i;"1"==BP_Messages.fastStart&&(l+="&fast=1"),location.href=l}}})}),jQuery(document).on("bp-better-messages-update-unread",function(e,s){var t=jQuery(".bp-better-messages-unread");0===(s=parseInt(s))?t.addClass("no-count"):t.removeClass("no-count"),t.text(s)});var z=!1,R=!1;e(document).on("bp-better-messages-open-mini-chat",function(e,s,t){b(s,t)}),e(document).on("bp-better-messages-open-private-thread",function(e,s){u(s)});var A,N=[]}(jQuery);